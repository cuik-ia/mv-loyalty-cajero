<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cajero ‚Äì Mascota Veloz Loyalty</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f3f3;
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    /* Layout con bandas laterales */
    .layout {
      display: flex;
      width: 100%;
      max-width: 1200px;
      min-height: 100vh;
    }

    .side-bar {
      width: 80px;
      background: #ff6b35;
      position: relative;
    }

    /* Patr√≥n simple de puntos ‚Äúfestivo‚Äù */
    .side-bar::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(circle, #ffffff 3px, transparent 4px);
      background-size: 24px 24px;
      opacity: 0.9;
    }

    /* Ocultar bandas en m√≥viles para que sea usable */
    @media (max-width: 900px) {
      .side-bar {
        display: none;
      }
      .layout {
        max-width: 100%;
      }
    }

    .main {
      flex: 1;
      padding: 24px 24px 40px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 900px;
    }

    /* Header con logo + t√≠tulo */
    .header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 8px;
    }

    .logo {
      height: 52px;
      border-radius: 10px;
      background: #fff;
      padding: 4px 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo img {
      max-height: 40px;
      display: block;
    }

    h1 {
      margin: 0;
      font-size: 22px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.06);
      margin-bottom: 18px;
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 4px;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #d3d3d3;
      font-size: 14px;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 2px rgba(255,107,53,0.2);
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1;
      min-width: 200px;
    }

    button {
      margin-top: 14px;
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #ff6b35;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(255,107,53,0.4);
      transition: transform 0.1s, box-shadow 0.1s, background 0.1s;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 5px 12px rgba(255,107,53,0.45);
      background: #ff5a1f;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .btn-secondary {
      background: #777;
      box-shadow: 0 3px 6px rgba(0,0,0,0.18);
    }

    .btn-secondary:hover:not(:disabled) {
      background: #666;
      box-shadow: 0 5px 12px rgba(0,0,0,0.22);
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      white-space: pre-line;
    }

    .status.error {
      color: #b00020;
    }

    .status.ok {
      color: #135e01;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      background: #ffe8d8;
      color: #a34a14;
      font-size: 11px;
      margin-left: 8px;
    }

    .session-info {
      font-size: 14px;
      color: #555;
      margin-top: 4px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div class="side-bar"></div>

    <div class="main">
      <div class="app">
        <!-- HEADER -->
        <div class="header">
          <div class="logo">
            <!-- Reemplaza la ruta del logo por la tuya -->
            <img src="mvlogo.png" alt="Mascota Veloz" />
          </div>
          <div>
            <h1>Mascota Veloz ‚Äì Panel de Cajero</h1>
            <div class="subtitle">
              Registrar visitas (m√≠n. S/80) y canjear premios del 10% (tope S/1000)
            </div>
          </div>
        </div>

        <!-- LOGIN -->
        <div id="login-card" class="card">
          <h2>Iniciar sesi√≥n</h2>
          <label for="login-email">Correo</label>
          <input id="login-email" type="email" placeholder="Ej: cuikperu@gmail.com" />

          <label for="login-password">Contrase√±a</label>
          <input id="login-password" type="password" placeholder="Contrase√±a" />

          <button id="login-btn">Ingresar</button>
          <div id="login-status" class="status"></div>
        </div>

        <!-- PANEL CAJERO -->
        <div id="panel" class="hidden">
          <div class="card">
            <h2>
              Informaci√≥n de sesi√≥n
              <span class="tag" id="store-tag">Tienda: -</span>
            </h2>
            <div class="session-info">
              Usuario: <span id="user-email">-</span>
            </div>
            <button id="logout-btn" class="btn-secondary">Cerrar sesi√≥n</button>
          </div>

          <!-- Registrar visita -->
          <div class="card">
            <h2>1. Registrar visita</h2>
            <div class="row">
              <div>
                <label for="scan-qr">QR del cliente (qr_code)</label>
                <input id="scan-qr" type="text" placeholder="Escanear QR o escribir c√≥digo..." />
              </div>
              <div>
                <label>Tienda</label>
                <input id="scan-store" type="text" disabled />
              </div>
              <div>
                <label for="scan-amount">Monto de la compra (S/)</label>
                <input id="scan-amount" type="number" min="0" step="0.1" placeholder="Ej: 120" />
              </div>
            </div>
            <button id="scan-btn">Registrar visita</button>
            <div id="scan-status" class="status"></div>
          </div>

          <!-- Canjear premio -->
          <div class="card">
            <h2>2. Canjear premio 10% (m√°x. S/1000)</h2>
            <div class="row">
              <div>
                <label for="redeem-qr">QR del cliente (qr_code)</label>
                <input id="redeem-qr" type="text" placeholder="Escanear QR o escribir c√≥digo..." />
              </div>
              <div>
                <label>Tienda</label>
                <input id="redeem-store" type="text" disabled />
              </div>
              <div>
                <label for="redeem-amount">Monto de la compra (S/)</label>
                <input id="redeem-amount" type="number" min="0" step="0.1" placeholder="Ej: 350" />
              </div>
            </div>
            <button id="redeem-btn">Canjear premio</button>
            <div id="redeem-status" class="status"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="side-bar"></div>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://gkmpmbrgrcsfbslnmrmy.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_7zFPkEvYdwquIgrpiKAFrQ_X0TBwGAI';

    const { createClient } = supabase;
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const loginCard = document.getElementById('login-card');
    const panel = document.getElementById('panel');

    const loginEmailInput = document.getElementById('login-email');
    const loginPasswordInput = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');
    const loginStatus = document.getElementById('login-status');

    const userEmailSpan = document.getElementById('user-email');
    const storeTag = document.getElementById('store-tag');
    const logoutBtn = document.getElementById('logout-btn');

    const scanBtn = document.getElementById('scan-btn');
    const scanStatus = document.getElementById('scan-status');
    const scanQrInput = document.getElementById('scan-qr');
    const scanStoreInput = document.getElementById('scan-store');
    const scanAmountInput = document.getElementById('scan-amount');

    const redeemBtn = document.getElementById('redeem-btn');
    const redeemStatus = document.getElementById('redeem-status');
    const redeemQrInput = document.getElementById('redeem-qr');
    const redeemStoreInput = document.getElementById('redeem-store');
    const redeemAmountInput = document.getElementById('redeem-amount');

    function showStatus(element, message, isError = false) {
      element.textContent = message;
      element.classList.remove('error', 'ok');
      element.classList.add(isError ? 'error' : 'ok');
    }

    async function loadSession() {
      const { data, error } = await supa.auth.getSession();
      if (error || !data.session) {
        // sin sesi√≥n
        loginCard.classList.remove('hidden');
        panel.classList.add('hidden');
        return;
      }

      const user = data.session.user;
      userEmailSpan.textContent = user.email;

      // obtener tienda
      const { data: storeData, error: storeError } = await supa.rpc('get_my_store');
      if (storeError || !storeData || storeData.length === 0) {
        showStatus(loginStatus, 'Error obteniendo tienda del usuario. Revisa store_users.', true);
        loginCard.classList.remove('hidden');
        panel.classList.add('hidden');
        return;
      }

      const storeName = storeData[0].store_name;
      storeTag.textContent = 'Tienda: ' + storeName;
      scanStoreInput.value = storeName;
      redeemStoreInput.value = storeName;

      loginCard.classList.add('hidden');
      panel.classList.remove('hidden');
    }

    // Login
    loginBtn.addEventListener('click', async () => {
      const email = loginEmailInput.value.trim();
      const password = loginPasswordInput.value.trim();

      if (!email || !password) {
        showStatus(loginStatus, 'Ingresa correo y contrase√±a.', true);
        return;
      }

      loginBtn.disabled = true;
      showStatus(loginStatus, 'Iniciando sesi√≥n...', false);

      const { data, error } = await supa.auth.signInWithPassword({ email, password });

      loginBtn.disabled = false;

      if (error) {
        showStatus(loginStatus, 'Error al iniciar sesi√≥n: ' + (error.message || ''), true);
        return;
      }

      showStatus(loginStatus, '', false);
      await loadSession();
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await supa.auth.signOut();
      panel.classList.add('hidden');
      loginCard.classList.remove('hidden');
      loginStatus.textContent = '';
      scanStatus.textContent = '';
      redeemStatus.textContent = '';
    });

    // Registrar visita
    scanBtn.addEventListener('click', async () => {
      const qr = scanQrInput.value.trim();
      const amount = parseFloat(scanAmountInput.value);

      if (!qr) {
        showStatus(scanStatus, 'Ingresa o escanea el QR del cliente.', true);
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        showStatus(scanStatus, 'Ingresa un monto de compra v√°lido.', true);
        return;
      }

      scanBtn.disabled = true;
      showStatus(scanStatus, 'Registrando visita...', false);

      const storeName = scanStoreInput.value; // solo informativo

      const { data, error } = await supa.rpc('scan_visit', {
        p_qr_code: qr,
        p_store: storeName,
        p_sale_amount: amount
      });

      scanBtn.disabled = false;

      if (error) {
        console.error(error);
        showStatus(scanStatus, 'Error: ' + (error.message || 'No se pudo registrar la visita.'), true);
        return;
      }

      const row = data && data[0];
      if (!row) {
        showStatus(scanStatus, 'No se recibi√≥ respuesta de la funci√≥n.', true);
        return;
      }

      const {
        client_id,
        client_name,
        visits_6m,
        total_visits,
        reward_created,
        reward_available,
        visit_registered
      } = row;

      let msg = `Cliente: ${client_name || 'Sin nombre'}\n`;
      msg += `Visitas del ciclo: ${visits_6m} de 6\n`;
      msg += `Visitas totales: ${total_visits}\n\n`;

      if (!visit_registered) {
        msg += '‚ö†Ô∏è La compra fue menor a S/80, no se registr√≥ visita en la tarjeta.\n';
        showStatus(scanStatus, msg, false);
        return;
      }

      if (visits_6m === 3) {
        msg += 'üéÅ Tercera visita del ciclo: entregar regalo sorpresa al cliente.\n';
      }

      if (reward_created) {
        msg += 'üéâ ¬°Nuevo premio creado! El cliente tiene 10% de descuento disponible para una pr√≥xima compra (tope S/1000).\n';
      } else if (reward_available) {
        msg += '‚úÖ El cliente ya tiene un 10% pendiente por canjear (tope S/1000).\n';
      } else {
        msg += '‚ÑπÔ∏è A√∫n no llega a las 6 visitas del ciclo.\n';
      }

      showStatus(scanStatus, msg, false);
    });

    // Canjear premio
    redeemBtn.addEventListener('click', async () => {
      const qr = redeemQrInput.value.trim();
      const amount = parseFloat(redeemAmountInput.value);

      if (!qr) {
        showStatus(redeemStatus, 'Ingresa o escanea el QR del cliente.', true);
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        showStatus(redeemStatus, 'Ingresa un monto v√°lido.', true);
        return;
      }

      redeemBtn.disabled = true;
      showStatus(redeemStatus, 'Procesando canje...', false);

      const storeName = redeemStoreInput.value; // solo informativo

      const { data, error } = await supa.rpc('redeem_reward', {
        p_qr_code: qr,
        p_store: storeName,
        p_sale_amount: amount
      });

      redeemBtn.disabled = false;

      if (error) {
        console.error(error);
        showStatus(redeemStatus, 'Error: ' + (error.message || 'No se pudo canjear el premio.'), true);
        return;
      }

      const row = data && data[0];
      if (!row) {
        showStatus(redeemStatus, 'No se recibi√≥ respuesta de la funci√≥n.', true);
        return;
      }

      const {
        client_name,
        sale_amount,
        discount_base,
        discount_applied,
        final_amount,
        reward_redeemed,
        discount_capped
      } = row;

      let msg = `Cliente: ${client_name || 'Sin nombre'}\n`;
      msg += `Monto compra: S/${sale_amount}\n`;
      msg += `Base descuento (tope S/1000): S/${discount_base}\n`;
      msg += `Descuento aplicado (10%): S/${discount_applied}\n`;
      msg += `Monto final a cobrar: S/${final_amount}\n\n`;

      if (reward_redeemed) {
        msg += '‚úÖ Premio canjeado correctamente (10% aplicado).\n';
        if (discount_capped) {
          msg += '‚ö†Ô∏è El descuento se aplic√≥ solo hasta S/1000 (tope de la promo).\n';
        }
      } else {
        msg += '‚ÑπÔ∏è No se marc√≥ el premio como redimido.\n';
      }

      showStatus(redeemStatus, msg, false);
    });

    // Al cargar la p√°gina, ver si ya hay sesi√≥n
    loadSession();
  </script>
</body>
</html>


